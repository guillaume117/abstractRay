# An unique identifier for the head node and workers of this cluster.
cluster_name: default

# The maximum number of workers nodes to launch in addition to the head
# node.
max_workers: 10

# The autoscaler will scale up the cluster faster with higher upscaling speed.
# E.g., if the task requires adding more nodes then autoscaler will gradually
# scale up the cluster in chunks of upscaling_speed*currently_running_nodes.
# This number should be > 0.
upscaling_speed: 5gcloud 

# This executes all commands on all nodes in the docker container,
# and opens all the necessary ports to support the Ray cluster.
# Empty string means disabled.
docker:
  image: "rayproject/ray-ml:latest-cpu" # You can change this to latest-cpu if you don't need GPU support and want a faster startup
    # image: rayproject/ray:latest-gpu   # use this one if you don't need ML dependencies, it's faster to pull
  container_name: "ray_container"
  pull_before_run: True
  run_options:
    - --ulimit nofile=65536:65536

idle_timeout_minutes: 5

provider:
    type: gcp
    region: europe-west9
    availability_zone: europe-west9-a
    project_id: gberthelot

auth:
    ssh_user: ubuntu

available_node_types:
    ray_head_default:
        resources: {"CPU": 8, "memory": 34359738368}
        node_config:
            machineType: n2-standard-8
            disks:
              - boot: true
                autoDelete: true
                type: PERSISTENT
                initializeParams:
                  diskSizeGb: 50
                  sourceImage: projects/deeplearning-platform-release/global/images/family/common-cpu
            networkInterfaces:
              - network: global/networks/default
                accessConfigs:
                  - name: External NAT
                    type: ONE_TO_ONE_NAT
                    # To allow external HTTP(S) traffic to reach the instances.
                    natIP: # If you have a static IP, you can specify it here.
    ray_worker_small:
        min_workers: 2
        max_workers: 9
        resources: {"CPU": 8, "memory": 34359738368}
        node_config:
            machineType: n2-standard-8
            disks:
              - boot: true
                autoDelete: true
                type: PERSISTENT
                initializeParams:
                  diskSizeGb: 50
                  sourceImage: projects/deeplearning-platform-release/global/images/family/common-cpu
            scheduling:
              - preemptible: true

head_node_type: ray_head_default
file_mounts: {
    "/home/ubuntu/app": "/home/guiberthelot/abstractRay/app"
}


cluster_synced_files: []

file_mounts_sync_continuously: False

rsync_exclude:
    - "**/.git"
    - "**/.git/**"

rsync_filter:
    - ".gitignore"

initialization_commands: []

setup_commands: []

head_setup_commands:
  - pip install google-api-python-client==1.7.8

worker_setup_commands: 
  - pip install google-api-python-client==1.7.8
head_start_ray_commands:
    - export RAY_memory_usage_threshold=0.98
    - ray stop
    - >-
      ray start
      --head
      --port=6379
      --object-manager-port=8076
      --autoscaling-config=~/ray_bootstrap_config.yaml
      --dashboard-host=0.0.0.0

worker_start_ray_commands:
    - export RAY_memory_usage_threshold=0.98
    - ray stop
    - >-
      ray start
      --address=$RAY_HEAD_IP:6379
      --object-manager-port=8076
